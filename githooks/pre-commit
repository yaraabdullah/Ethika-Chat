#!/bin/bash
# Pre-commit hook to prevent API keys and secrets from being committed
# This file is tracked in git and should be installed via scripts/install-hooks.sh

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "üîí Checking for secrets and API keys..."

PATTERNS=(
    "AIzaSy[0-9A-Za-z_-]{35}"          # Google API keys (legacy)
    "sk-[0-9A-Za-z]{32,}"              # OpenAI API keys
    "AKIA[0-9A-Z]{16}"                 # AWS Access Key IDs
    "[0-9a-zA-Z/+=]{40}"               # AWS Secret Access Keys
    "xox[baprs]-[0-9a-zA-Z-]{10,48}"  # Slack tokens
    "ghp_[0-9a-zA-Z]{36}"              # GitHub Personal Access Token
    "ghu_[0-9a-zA-Z]{36}"              # GitHub User-to-Server token
    "gho_[0-9A-Za-z]{36}"              # GitHub OAuth token
    "ghr_[0-9A-Za-z]{76}"              # GitHub Refresh token
    "up_[0-9A-Za-z]{40,}"              # Upstage API keys (common format)
)

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
FOUND_SECRET=0

for file in $STAGED_FILES; do
    [ ! -f "$file" ] && continue
    
    if git diff --cached -- "$file" | grep -q "^Binary files differ"; then
        continue
    fi
    
    # Skip documentation files (they contain examples, not real keys)
    if [[ "$file" == *.md ]] || [[ "$file" == *.txt ]] || [[ "$file" == SECURITY.md ]] || [[ "$file" == FIX_API_KEY.md ]] || [[ "$file" == PERMANENT_FIX.md ]]; then
        continue
    fi
    
    for pattern in "${PATTERNS[@]}"; do
        if git diff --cached -- "$file" | grep -qE "$pattern"; then
            echo -e "${RED}‚ùå SECRET DETECTED!${NC}"
            echo -e "${RED}File: $file${NC}"
            echo -e "${RED}Pattern matched: $pattern${NC}"
            echo -e "${YELLOW}‚ö†Ô∏è  Do not commit secrets or API keys!${NC}"
            echo -e "${YELLOW}If this is a false positive, use: git commit --no-verify${NC}"
            FOUND_SECRET=1
        fi
    done
    
    # Check for .env files being committed
    if [[ "$file" == *.env && "$file" != *.env.example ]]; then
        echo -e "${RED}‚ùå ERROR: Attempting to commit .env file: $file${NC}"
        echo -e "${YELLOW}‚ö†Ô∏è  .env files should NEVER be committed to git!${NC}"
        echo -e "${YELLOW}Add it to .gitignore or use .env.example instead.${NC}"
        FOUND_SECRET=1
    fi
done

if [ $FOUND_SECRET -eq 1 ]; then
    echo -e "${RED}üö´ Commit blocked to protect your secrets!${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ No secrets detected. Proceeding with commit...${NC}"
exit 0

